<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Notification Manager</title>
  <style>
    :root {
      --primary: #0f3c6e;
      --accent: #f6b800;
      --bg: #f4f7fb;
      --card: #ffffff;
    }
    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      font-family: "Segoe UI", sans-serif;
      color: var(--primary);
    }
    h2 {
      color: var(--primary);
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 5px 2px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
    }
    button:hover {
      background: var(--accent);
      color: black;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    textarea {
      height: 200px;
      font-family: monospace;
    }
    .card {
      background: var(--card);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section-title {
      margin-top: 0;
      font-size: 18px;
      color: var(--primary);
    }
    .error {
      color: red;
      font-size: 14px;
      margin: 5px 0;
    }
    .note {
      font-size: 12px;
      color: #555;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h2>üì¢ Notification Manager</h2>
  <div class="card">
    <button onclick="previewNotification()">üîç Preview Notification</button>
    <button onclick="showEditForm()">‚úèÔ∏è Edit Notification</button>
  </div>
  <div id="formSection" class="card"></div>
  <div id="previewSection" class="card"></div>
  <script>
    const notificationUrl = "https://raw.githubusercontent.com/lyfe05/RandomProject/refs/heads/main/message.json";
    const repoOwner = "lyfe05";
    const repoName = "RandomProject";
    const filePath = "message.json";
    const branch = "main";
    let notificationData = {};
    let githubToken = null;

    function getCurrentUTCTime() {
      return new Date().toISOString();
    }

    function validateInputs(fields) {
      for (const [id, value] of Object.entries(fields)) {
        if (!value.trim()) {
          alert(`‚ùå ${id} cannot be empty.`);
          return false;
        }
      }
      return true;
    }

    async function fetchNotification() {
      if (!githubToken) {
        alert("‚ùå Please enter a GitHub Personal Access Token to fetch the notification.");
        showTokenPrompt();
        return false;
      }
      try {
        const res = await fetch(`${notificationUrl}?t=${new Date().getTime()}`, {
          headers: { Authorization: `Bearer ${githubToken}` }
        });
        if (!res.ok) {
          if (res.status === 404) {
            console.warn("Notification file not found, initializing empty object.");
            notificationData = {
              notification_message: "",
              notification_visible: false,
              last_updated: getCurrentUTCTime()
            };
            return true;
          }
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        const text = await res.text();
        if (!text) {
          console.warn("Notification file is empty, initializing empty object.");
          notificationData = {
            notification_message: "",
            notification_visible: false,
            last_updated: getCurrentUTCTime()
          };
          return true;
        }
        notificationData = JSON.parse(text);
        return true;
      } catch (error) {
        console.error("Error fetching notification:", error);
        notificationData = {
          notification_message: "",
          notification_visible: false,
          last_updated: getCurrentUTCTime()
        };
        alert("‚ùå Failed to fetch notification. Check token permissions for private repo. Error: " + error.message);
        return false;
      }
    }

    async function publishToGitHub(updatedJson) {
      if (!githubToken) {
        alert("‚ùå Please enter a GitHub Personal Access Token to publish changes.");
        showTokenPrompt();
        return false;
      }
      try {
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
        let sha;
        try {
          const current = await fetch(apiUrl, {
            headers: { Authorization: `Bearer ${githubToken}` }
          });
          if (current.ok) {
            const data = await current.json();
            sha = data.sha;
          } else if (current.status === 404) {
            console.warn(`File ${filePath} not found on GitHub, creating new.`);
            sha = null;
          } else {
            throw new Error(`HTTP error! Status: ${current.status}`);
          }
        } catch (error) {
          console.error("Error fetching SHA:", error);
          alert("‚ùå Failed to fetch file metadata. Check token permissions for private repo. Error: " + error.message);
          return false;
        }
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(updatedJson, null, 2))));
        const pushRes = await fetch(apiUrl, {
          method: "PUT",
          headers: { Authorization: `Bearer ${githubToken}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `Update ${filePath} via Notification Manager UI`,
            content: encoded,
            sha: sha,
            branch: branch
          })
        });
        if (!pushRes.ok) {
          throw new Error(`HTTP error! Status: ${pushRes.status}`);
        }
        alert("‚úÖ Changes published successfully!");
        return true;
      } catch (error) {
        console.error("Error publishing to GitHub:", error);
        alert("‚ùå Publish failed. Check token permissions for private repo. Error: " + error.message);
        return false;
      }
    }

    async function previewNotification() {
      if (await fetchNotification()) {
        document.getElementById("previewSection").innerHTML = `
          <h3 class="section-title">Preview Notification</h3>
          <textarea readonly>${JSON.stringify(notificationData, null, 2)}</textarea>
        `;
      }
    }

    function showTokenPrompt() {
      document.getElementById("formSection").innerHTML = `
        <h3 class="section-title">Enter GitHub Personal Access Token</h3>
        <input type="password" id="githubToken" placeholder="GitHub Personal Access Token" />
        <p class="note">Token requires 'repo' scope for private repo access. Generate at https://github.com/settings/tokens.</p>
        <button onclick="saveToken()">‚úÖ Save Token</button>
      `;
    }

    function saveToken() {
      const token = document.getElementById("githubToken").value.trim();
      if (!token) {
        alert("‚ùå GitHub Personal Access Token cannot be empty.");
        return;
      }
      githubToken = token;
      document.getElementById("formSection").innerHTML = '';
      alert("‚úÖ Token saved. You can now fetch or publish changes.");
    }

    function showEditForm() {
      fetchNotification().then(() => {
        document.getElementById("formSection").innerHTML = `
          <h3 class="section-title">Edit Notification</h3>
          <input type="text" id="notificationMessage" value="${notificationData.notification_message || ''}" placeholder="Notification Message" />
          <label><input type="checkbox" id="notificationVisible" ${notificationData.notification_visible ? 'checked' : ''}> Visible</label>
          <input type="text" id="lastUpdated" value="${notificationData.last_updated || getCurrentUTCTime()}" readonly />
          <p class="note">Last updated will be set to current UTC time on save.</p>
          <button onclick="previewEdit()">‚úÖ Preview Edit</button>
          <button onclick="publishEdit()">üöÄ Publish</button>
        `;
      });
    }

    function previewEdit() {
      const fields = {
        "Notification Message": document.getElementById("notificationMessage").value.trim()
      };
      if (!validateInputs(fields)) return;

      const newData = {
        notification_message: fields["Notification Message"],
        notification_visible: document.getElementById("notificationVisible").checked,
        last_updated: getCurrentUTCTime()
      };

      document.getElementById("previewSection").innerHTML = `
        <h3 class="section-title">Preview Edited Notification</h3>
        <textarea readonly>${JSON.stringify(newData, null, 2)}</textarea>
      `;
    }

    async function publishEdit() {
      const fields = {
        "Notification Message": document.getElementById("notificationMessage").value.trim()
      };
      if (!validateInputs(fields)) return;

      const updatedData = {
        notification_message: fields["Notification Message"],
        notification_visible: document.getElementById("notificationVisible").checked,
        last_updated: getCurrentUTCTime()
      };

      if (await publishToGitHub(updatedData)) {
        notificationData = updatedData;
        await previewNotification();
      }
    }
  </script>
</body>
</html>
